<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StayNest</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="/css/style.css">
</head>

<body class="layout-body">

  <%- include("../includes/navbar") %>

  <div class="app-layout <%= !currentUser ? 'auth-layout' : '' %>">

    <% if(currentUser){ %>
      <%- include("../includes/sidebar") %>
    <% } %>

    <main class="main-content">
      <% if(!currentUser){ %>
        <%- body %>
      <% } else { %>
        <div class="page-wrapper">
          <%- body %>
        </div>
      <% } %>
    </main>

  </div>

  <%- include("../includes/footer") %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>

  (function () {
    "use strict";

    // ── Element refs ──────────────────────────────────────────
    const body        = document.body;
    const sidebar     = document.getElementById("sidebar");
    const desktopBtn  = document.getElementById("toggleSidebar");    // desktop only
    const navbarBtn   = document.getElementById("navSidebarToggle"); // mobile only (in navbar)
    const savedState  = localStorage.getItem("sidebarState");


    // ── Breakpoint helper ─────────────────────────────────────

    const isMobile = () => window.innerWidth <= 991;

    // ✅ restore collapsed state (desktop only)

    if (!isMobile() && localStorage.getItem("sn_sidebar_collapsed") === "1") {
      body.classList.add("sidebar-collapsed");
    }

    // ── Mobile open/close ─────────────────────────────────────
    function openSidebar()  {
      body.classList.remove("sidebar-collapsed");
      body.classList.add("sidebar-open");
     }
    function closeSidebar() { body.classList.remove("sidebar-open"); }
    function toggleMobile() {
      body.classList.contains("sidebar-open") ? closeSidebar() : openSidebar();
    }

    // ── Desktop collapse ──────────────────────────────────────
    function toggleDesktop() {
    const collapsed = body.classList.toggle("sidebar-collapsed"); // addition 1

    // NEW primary key
    if (collapsed) {
      localStorage.setItem("sn_sidebar_collapsed", "1");
    } else {
      localStorage.removeItem("sn_sidebar_collapsed");
    }

    // keep your existing key (minimal change)
    localStorage.setItem("sidebarState", collapsed ? "collapsed" : "expanded"); // addition 2

    // stability helper (prevents redirect flicker)
    body.dataset.sidebar = collapsed ? "collapsed" : "expanded"; // addition 3
  }

    // ── Bind navbar button (mobile toggle) ───────────────────
    if (navbarBtn) {
      navbarBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        if (isMobile()) toggleMobile();
      });
    }

    // ── Bind desktop sidebar button ───────────────────────────
    if (desktopBtn) {
      desktopBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        if (!isMobile()) toggleDesktop();
      });
    }

    // ── Click-outside: close sidebar on mobile ────────────────
    document.addEventListener("click", function (e) {
      if (!isMobile()) return;
      if (!sidebar.contains(e.target) && navbarBtn && !navbarBtn.contains(e.target)) {
        closeSidebar();
      }
    });

    // ── Escape key closes sidebar ─────────────────────────────
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && isMobile()) closeSidebar();
    });

    // ── Resize: clean up state when crossing breakpoint ───────
    let lastMobile = isMobile();
    window.addEventListener("resize", function () {
      const nowMobile = isMobile();
      if(nowMobile){
        body.classList.remove("sidebar-collapsed");
      }

      if (nowMobile !== lastMobile) {
        // Crossed breakpoint — reset both states
        closeSidebar();
        body.classList.remove("sidebar-collapsed");
        lastMobile = nowMobile;
      }
    });

  }());
  </script>

</body>
</html>
