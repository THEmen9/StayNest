
<div class="row g-3">

  <!-- ================= LEFT — DETAILS ================= -->
  <div class="<%= showReserve ? 'col-lg-8' : 'col-lg-12' %>">

    <div class="card shadow-sm border-0">
      <div class="card-body">

        <!-- TITLE -->
        <h3 class="fw-semibold mb-3"><%= listing.title %></h3>

        <!-- CAROUSEL -->
        <div id="listingCarousel" class="carousel slide mb-3">
          <div class="carousel-inner rounded">

            <% listing.images.forEach((img,index)=>{ %>
              <div class="carousel-item <%= index===0 ? 'active':'' %>">
                <img
                  src="<%= img.url.startsWith('http') ? img.url : '/' + img.url %>"
                  class="d-block w-100"
                  style="height:360px; object-fit:cover;">
              </div>
            <% }) %>

          </div>

          <% if(listing.images.length>1){ %>
          <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
          <% } %>
        </div>

        <!-- DESCRIPTION -->
        <p class="text-muted"><%= listing.description %></p>

        <!-- META -->
        <div class="mb-2"><strong>Price:</strong> ₹ <%= listing.price %></div>
        <div class="mb-2"><strong>Location:</strong> <%= listing.location %></div>
        <div class="mb-3"><strong>Country:</strong> <%= listing.country %></div>

        <!-- OWNER ACTIONS -->
        <% if(currentUser && listing.owner &&
            (listing.owner.toString() === currentUser._id.toString() ||
             currentUser.role === "dev")){ %>

          <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">Edit</a>

          <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="d-inline">
            <button class="btn btn-danger">Delete</button>
          </form>

        <% } %>

      </div>
    </div>

  </div>


  <!-- ================= RIGHT — BOOKING ================= -->
  <% if(showReserve){ %>
  <div class="col-lg-4">

    <div class="card shadow-sm border-0 sticky-booking p-3" id="bookingPanel">

      <h5 class="fw-bold mb-2">Reserve this stay</h5>
      <hr>

      <% if(currentUser){ %>

      <form id="bookingForm" action="/listings/<%= listing._id %>/book" method="POST">
        <div id="bookingMessage"></div>

        <h5 class="fw-bold mb-3">
          ₹ <span id="priceDisplay"><%= listing.price %></span>
          <small class="text-muted">/ night</small>
        </h5>

        <label class="form-label">Booking Type</label>
        <select name="bookingType" id="bookingType" class="form-select mb-2">
          <option value="whole">Whole Property</option>
          <option value="room">Rooms</option>
        </select>

        <div id="roomField" class="d-none">
          <label class="form-label">Number of Rooms</label>
          <input type="number"
                 name="roomsBooked"
                 id="roomsBooked"
                 min="1"
                 max="<%= listing.totalRooms || 5 %>"
                 value="1"
                 class="form-control mb-2">
        </div>

        <label class="form-label">Check In</label>
        <input type="date" name="checkIn" class="form-control mb-2" required>

        <label class="form-label">Check Out</label>
        <input type="date" name="checkOut" class="form-control mb-2" required>

        <label class="form-label">Guests</label>
        <input type="number" name="guests" value="1" min="1" class="form-control mb-3">

        <button id="reserveBtn" class="btn btn-dark w-100 fw-semibold">
          Reserve
        </button>

      </form>

      <% } else { %>

      <div class="text-center">
        <p class="text-muted">Login to reserve this stay</p>
        <a href="/login" class="btn btn-dark w-100">Login</a>
      </div>

      <% } %>

    </div>

  </div>
  <% } %>

</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

  /*BOOKING UI LOGIC */

  const form         = document.getElementById("bookingForm");
  if (!form) return;

  const bookingType  = document.getElementById("bookingType");
  const roomField    = document.getElementById("roomField");
  const roomsInput   = document.getElementById("roomsBooked");
  const priceDisplay = document.getElementById("priceDisplay");
  const btn          = form.querySelector("button");

  const wholePrice   = Number("<%= listing.price %>");
  const totalRooms   = Number("<%= listing.totalRooms || 1 %>");
  const roomPrice    = wholePrice / totalRooms;


  /* PRICE CALCULATION */

  function getNights(){
    const checkIn  = new Date(form.checkIn.value);
    const checkOut = new Date(form.checkOut.value);

    if (!form.checkIn.value || !form.checkOut.value) return 1;

    const diff = checkOut - checkIn;
    const nights = Math.ceil(diff / (1000 * 60 * 60 * 24));

    return nights > 0 ? nights : 1;
  }

  function updatePrice(){

    const type   = bookingType.value;
    const rooms  = Number(roomsInput?.value) || 1;
    const nights = getNights();

    if(type === "room"){
      roomField.classList.remove("d-none");
      priceDisplay.textContent = Math.round(roomPrice * rooms * nights);
    } else {
      roomField.classList.add("d-none");
      priceDisplay.textContent = wholePrice * nights;
    }
  }

  bookingType.addEventListener("change", updatePrice);
  roomsInput?.addEventListener("input", updatePrice);
  form.checkIn.addEventListener("change", updatePrice);
  form.checkOut.addEventListener("change", updatePrice);

  updatePrice();


  /* FORM SUBMISSION (AJAX) */

  form.addEventListener("submit", async function(e){

    e.preventDefault();

    btn.disabled = true;
    btn.innerText = "Processing...";

    const data = {
      checkIn: this.checkIn.value,
      checkOut: this.checkOut.value,
      guests: this.guests.value,
      bookingType: this.bookingType.value,
      roomsBooked: this.roomsBooked?.value
    };

    try {

      const response = await fetch(this.action, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      showToast(result.message, result.success ? "success" : "error");

    } catch (err) {
      if (!response.ok) {
      showToast("Server error. Please try again.", "error");
      btn.disabled = false;
      btn.innerText = "Reserve";
      return;
  }
    }

    btn.disabled = false;
    btn.innerText = "Reserve";

  });


  /* INLINE TOAST SYSTEM */

  function showToast(message, type){

    const container = document.getElementById("bookingMessage");
    if(!container) return;

    container.innerHTML = "";

    const div = document.createElement("div");
    div.className = "inline-toast " + (type === "error" ? "error" : "");
    div.innerText = message;

    container.appendChild(div);

    setTimeout(()=>{
      div.style.opacity = "0";
      setTimeout(()=> div.remove(), 300);
    }, 2500);
  }

});
</script>




<script src="/js/map.js"></script>
